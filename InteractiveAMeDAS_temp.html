<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>アメダス気温観測マップ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    /* 地図表示領域 */
    #map {
      width: 100%;
      height: 100vh;
    }
    /* ※ 数字表示用・丸表示用ともに基本となるスタイル（必要に応じて調整） */
    .amedas-marker {
      text-align: center;
      font-weight: bold;
      /* 数字表示時は背景などは inline style で指定 */
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    /********************
     * ヘルパー関数群
     ********************/

    // 気温に合わせた色を返す
    function getColorForTemperature(temp) {
      if (temp < -5) return "#002080";
      else if (temp < 0) return "#0041ff";
      else if (temp < 5) return "#0096ff";
      else if (temp < 10) return "#b9ebff";
      else if (temp < 15) return "#ffff96";
      else if (temp < 20) return "#faf500";
      else if (temp < 25) return "#ff9900";
      else if (temp < 30) return "#ff6633";
      else if (temp < 35) return "#ff2800";
      else return "#b40068";
    }

    // 数字表示用のアイコン（高倍率時用）
    function getNumberIcon(temp) {
      var color = getColorForTemperature(temp);
      // 数値のみ表示
      var displayTemp = temp.toFixed(1);
      // 温度が5℃以上の場合は黒い縁取り、そうでなければ白い縁取り
      var shadowColor = (temp >= 5) ? "#000" : "#fff";
      return L.divIcon({
        className: 'amedas-marker',
        html: '<div style="color:' + color + '; font-size:14px; font-weight:bold; text-shadow: -1px -1px 0 ' + shadowColor + ', 1px -1px 0 ' + shadowColor + ', -1px 1px 0 ' + shadowColor + ', 1px 1px 0 ' + shadowColor + ';">' + displayTemp + '</div>',
        iconSize: null
      });
    }



    // 丸表示用のアイコン（低倍率時用）
    function getCircleIcon(temp) {
      var color = getColorForTemperature(temp);
      return L.divIcon({
        className: 'amedas-marker',
        html: '<div style="width:12px; height:12px; background:' + color + '; border: 1px solid ' + color + '; border-radius:50%;"></div>',
        iconSize: [12, 12],
        iconAnchor: [6, 6]
      });
    }

    // 拡大率（zoom）に応じて各マーカーのアイコンを更新
    // zoomThreshold 以下なら丸表示、それ以上なら数字表示
    var zoomThreshold = 8;
    // すべてのマーカーを格納する配列
    var amedasMarkers = [];
    function updateAmedasIcons() {
      var currentZoom = map.getZoom();
      amedasMarkers.forEach(function(marker) {
        var temp = marker.amedasData.temp;
        if (currentZoom >= zoomThreshold) {
          marker.setIcon(getNumberIcon(temp));
        } else {
          marker.setIcon(getCircleIcon(temp));
        }
      });
    }

    // 全国最新気象データ（map用）の取得
    async function getLatestMapData() {
      // 最新時刻の取得（例："2025-02-08T13:40:00+09:00"）
      const resTime = await fetch("https://www.jma.go.jp/bosai/amedas/data/latest_time.txt");
      const latestTimeText = (await resTime.text()).trim();
      const latestTime = new Date(latestTimeText);
      // フォーマット：YYYYMMDDhhmmss（秒まで）
      const formatted = 
            latestTime.getFullYear().toString() +
            String(latestTime.getMonth() + 1).padStart(2, '0') +
            String(latestTime.getDate()).padStart(2, '0') +
            String(latestTime.getHours()).padStart(2, '0') +
            String(latestTime.getMinutes()).padStart(2, '0') +
            String(latestTime.getSeconds()).padStart(2, '0');
      const url = "https://www.jma.go.jp/bosai/amedas/data/map/" + formatted + ".json";
      const response = await fetch(url);
      const mapData = await response.json();
      return mapData;
    }

    /********************
     * メイン処理
     ********************/

    // 地図の初期化（日本付近）
    const map = L.map('map').setView([35.6895, 139.6917], 5);

    // 地理院タイルの設定
    L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
      attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"
    }).addTo(map);

    // マップの空白部分クリックでグラフポップアップを閉じる
    var currentPopup = null;
    map.on('click', function(e) {
      if (currentPopup) {
        currentPopup.remove();
        currentPopup = null;
      }
    });

    // 最新の気象データと地点一覧を同時に取得
    Promise.all([
      fetch("https://www.jma.go.jp/bosai/amedas/const/amedastable.json").then(r => r.json()),
      getLatestMapData()
    ]).then(([amedasData, latestMapData]) => {
      // 各観測所ごとに処理
      for (const stnid in amedasData) {
        const station = amedasData[stnid];
        if (!station) continue;
        // elems の先頭が '0' なら気温データがないとみなしスキップ
        if (!station.elems || station.elems.charAt(0) === '0') continue;
        // 座標チェック（[度, 分]の配列であること）
        if (!station.lat || !station.lon ||
            !Array.isArray(station.lat) || station.lat.length < 2 ||
            !Array.isArray(station.lon) || station.lon.length < 2) {
          console.warn(`Station ${stnid} has invalid lat/lon data. Skipping.`);
          continue;
        }
        // 座標を10進法に変換
        const lat = station.lat[0] + station.lat[1] / 60;
        const lon = station.lon[0] + station.lon[1] / 60;

        // 最新の気象データから対象観測所の気温を取得
        const mapObs = latestMapData[stnid];
        if (!mapObs || !mapObs.temp) continue;
        const tempValue = mapObs.temp[0];
        const quality = mapObs.temp[1];
        if (quality !== 0) continue;  // 品質が0以外は欠測扱い

        // マーカーの表示：現在の拡大率によって数字表示 or 丸表示
        var currentZoom = map.getZoom();
        var icon;
        if (currentZoom >= zoomThreshold) {
          icon = getNumberIcon(tempValue);
        } else {
          icon = getCircleIcon(tempValue);
        }
        // マーカー作成（L.marker で作成し、作成時のアイコンを指定）
        const marker = L.marker([lat, lon], { icon: icon }).addTo(map);
        // マーカーに必要な情報を保持
        marker.amedasData = { stnid: stnid, station: station, temp: tempValue };
        // 配列に登録（後で拡大率に合わせたアイコン更新のため）
        amedasMarkers.push(marker);

        // マーカークリック時：詳細グラフのポップアップを表示
        marker.on('click', async function(e) {
          // クリックイベントの伝播を止める
          e.originalEvent.stopPropagation();
          // すでに別のポップアップが開いていれば閉じる
          if (currentPopup && currentPopup !== marker.getPopup()) {
            currentPopup.remove();
          }
          // ポップアップを生成
          marker.bindPopup("気温データを取得中...", {
            offset: L.point(0, -15),
            maxWidth: 500,
            minWidth: 200
          }).openPopup();
          currentPopup = marker.getPopup();

          try {
            // 個別観測所の過去約24時間分の時系列データ取得
            const result = await getTemperatureData(stnid);
            // ユニークな canvas ID を生成
            const canvasId = "chartCanvas-" + stnid;
            // ポップアップ内の内容を canvas タグに置換
            marker.getPopup().setContent('<canvas id="' + canvasId + '" width="500" height="300"></canvas>');
            marker.getPopup().update();

            // Chart.js によりグラフ描画
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
              type: 'line',
              data: {
                labels: result.labels,  // 例: ["00:00", "00:10", … "23:50"]
                datasets: [{
                  label: '気温 (°C)',
                  data: result.temperatures,
                  borderColor: 'blue',
                  backgroundColor: 'rgba(0, 0, 255, 0.1)',
                  borderWidth: 1,
                  pointRadius: 1,
                  pointBackgroundColor: 'blue',
                  fill: true,
                  tension: 0
                }]
              },
              options: {
                plugins: {
                  title: {
                    display: true,
                    text: stnid + " " + station.kjName + " " + station.knName + " (標高: " + station.alt + "m)"
                  },
                  tooltip: {
                    mode: 'index',
                    intersect: false
                  }
                },
                hover: {
                  mode: 'index',
                  intersect: false
                },
                scales: {
                  x: {
                    ticks: {
                      autoSkip: false,
                      callback: function(value, index, ticks) {
                        let label = result.labels[index];
                        return label.endsWith(':00') ? label : '';
                      }
                    },
                    title: {
                      display: true,
                      text: '時刻'
                    }
                  },
                  y: {
                    title: {
                      display: true,
                      text: '気温 (°C)'
                    }
                  }
                }
              }
            });
          } catch (error) {
            console.error("温度データ取得エラー:", error);
            marker.getPopup().setContent("データの取得に失敗しました。");
          }
        });
      } // 各観測所ループ終わり
    }).catch(err => {
      console.error("データ取得に失敗:", err);
    });

    // 地図の拡大／縮小時に各マーカーのアイコンを更新
    map.on('zoomend', updateAmedasIcons);

    /********************
     * 個別地点の時系列データ取得
     ********************/
    /**
     * 指定された観測所 (stnid) の過去約24時間分の時系列気温データを取得する関数  
     * 最新時刻から直近の3時間ブロックを求め、そこから3時間間隔で8ブロック分のデータを結合  
     * @param {string} stnid - 観測所番号（例："11001"）  
     * @returns {Promise<{labels: string[], temperatures: number[]}>}
     */
    async function getTemperatureData(stnid) {
      const resTime = await fetch("https://www.jma.go.jp/bosai/amedas/data/latest_time.txt");
      const latestTimeText = (await resTime.text()).trim();
      const latestTime = new Date(latestTimeText);

      const currentHour = latestTime.getHours();
      const blockHour = Math.floor(currentHour / 3) * 3;
      const baseBlockTime = new Date(latestTime);
      baseBlockTime.setHours(blockHour, 0, 0, 0);

      let fetchPromises = [];
      for (let i = 0; i < 8; i++) {
        let blockTime = new Date(baseBlockTime);
        blockTime.setHours(baseBlockTime.getHours() - 3 * i);
        const year = blockTime.getFullYear();
        const month = String(blockTime.getMonth() + 1).padStart(2, '0');
        const day = String(blockTime.getDate()).padStart(2, '0');
        const hour = String(blockTime.getHours()).padStart(2, '0');
        const yyyymmdd = `${year}${month}${day}`;
        const url = `https://www.jma.go.jp/bosai/amedas/data/point/${stnid}/${yyyymmdd}_${hour}.json`;
        
        fetchPromises.push(
          fetch(url)
            .then(response => response.json())
            .catch(err => {
              console.error("データ取得失敗:", url, err);
              return null;
            })
        );
      }

      const blocksData = await Promise.all(fetchPromises);
      let combinedData = {};
      blocksData.forEach(block => {
        if (block) {
          for (const timeKey in block) {
            combinedData[timeKey] = block[timeKey];
          }
        }
      });

      const sortedKeys = Object.keys(combinedData).sort();
      let labels = [];
      let temperatures = [];
      sortedKeys.forEach(key => {
        const obs = combinedData[key];
        if (obs && obs.temp && Array.isArray(obs.temp) && obs.temp.length > 0) {
          const hour = key.substring(8, 10);
          const minute = key.substring(10, 12);
          labels.push(`${hour}:${minute}`);
          temperatures.push(obs.temp[0]);
        }
      });
      return { labels, temperatures };
    }
  </script>
</body>
</html>
